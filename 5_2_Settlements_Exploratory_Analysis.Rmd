---
title: "5.2. Settlements Exploratory Analysis"
author: "Alexander Sheludkov"
date: "26 11 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, message=TRUE, warning=TRUE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggforce)
library(corrplot)
library(caret)
library(RColorBrewer)
```

```{r load data}
load(file = "data/Part3_res_dataset.Rdata")
load("data/settlements.Rdata")
```

## Как структурное положение н.п. в сети населенных пунктов влияло на динамику его населения?

Переменная, которую мы будем предсказывать: `pop2010to2002_rel` (отношение населения в 2010 году к населению в 2002)

### Preprocessing

Удалим лишние переменные из датасета

```{r}
df %>% 
  dplyr:: select(-id, - lon, -lat, -ShortName, -MunicipalDistrict, -Rosstat1990, -clust_3, -clust_6, -clust_18)->
  df_cleaned
```

Построим корреляционную матрицу

```{r fig.height=10, fig.width=10}
corr <- cor(df_cleaned)
corrplot(corr, method = "circle")
```

Спросим у `caret`, какие переменные нужно выкинуть. Порог 0.8

```{r}
findCorrelation(corr, cutoff = 0.8, names = T)
```

Выкидываем избыточные переменные

`Census2002` vs `Census2010`: оставляем данные за 2002 год - ответим на вопрос, зависит ли динамика населения от первоначальной величины населенного пункта  
`dist2Tyumen` *(расстояние до Тюмени)* vs `clo_w` *(взвешенная по численности населения центральность по близости)* vs `CL18_dist2Tyumen` *(средневзвешенное по населению расстояние от кластера до Тюмени)*: чистое расстояние и центральность  -важные переменные, которые сильно коррелируют. Я бы затестил каждую, чтобы понять, которая вносит более весомый вклад - расстояние до главного города или взвешенное расстояние до всех городов?  
`betw_CL6` vs `betw_CL18`: сложный выбор. Обе центральности по постредничеству, рассчитанные с ограничением максимальной дины пути, учитываемой в вычислениях, медианой пути внутри кластеров - 98.2 км (для 6 кластеров) и 52 км (для 18 кластеров). Интересно, что ни с чем больше ни одна из переменных не коррелирует (например, с центральностью по близости, что могло быть ожидаемым).  
`clo_CL6` (центральность по близости по 6 кластерам) vs `CL6_n` (число н.п. в кластере) vs `CL6_density` vs `CL6_variance_2002` - в приоритете характеристика самого н.п. (`clo_CL6`) + не уверен насчет `CL6_variance_2002`, остальное выкидываем.  
  
Остальные переменные характеризуют не н.п., а кластеры, в которых они находятся:  
`CL6_pop2002`, `CL18_pop2002`, `CL6_pop2010`, `CL18_pop2010` - выкидываем  
`CL6_variance_2010`, `CL18_variance_2010` - выкидываем  
`CL6_pop2010to2002_rel` - коррелирует с расстоянием до Тюмени, выкидываем  
`CL6_max_pop2002`, `CL6_mean_pop2002`, `CL6_median_pop2002` - коррелируют между собой и с показателями вариации. Показатели вариации несут больше смысла - так что этих ребят выкидываем  
`CL6_median_path`, `CL6_density`, `CL18_median_path`, `CL18_density` - оставим пока плотность  

`CL18_density` *(плотность графа)*, `CL18_centr_clo` *(централизация по близости)* - довольно неожиданное сочетание. Надо подробнее изучить

```{r}
clusters_18_metrics %>% 
  ggplot(aes(x = CL18_density, y = CL18_centr_clo))+
  geom_point()+
  geom_text(aes(x = CL18_density+0.0005, y = CL18_centr_clo - 0.001, label = clust_18))
```

Чем выше плотность графа - тем выше централизация сети по близости (?). Довольно контр-интуитивная штука  

Посмотрим на корреляцию оставшихся переменных:

```{r fig.height=10, fig.width=10}
df_cleaned %>% 
  dplyr::select(-Census2010, 
                -CL18_dist2Tyumen, 
                -betw_CL18, 
                -CL6_n, 
                -CL6_pop2002,
                -CL6_pop2010,
                -CL18_pop2002,
                -CL18_pop2010,
                -CL6_variance_2010,
                -CL18_variance_2010,
                -CL6_pop2010to2002_rel,
                -CL6_max_pop2002,
                -CL6_mean_pop2002,
                -CL6_median_pop2002,
                -CL18_max_pop2002,
                -CL18_mean_pop2002,
                -CL18_median_pop2002,
                -CL6_median_path,
                -CL18_median_path) %>% cor() -> corr

corrplot(corr, "number")
```



